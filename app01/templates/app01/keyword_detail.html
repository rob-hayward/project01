{% extends "app01/base.html" %}
{% load crispy_forms_tags %}
{% load highlight_keywords %}

{% block content %}
    <div style="display: flex; align-items: baseline;">
        <h1 style="margin-right: 20px;">{{ keyword.word }}</h1>
        <p>Current keyword status: <span id="keyword_status" class="{{ keyword.status|lower }}">{{ keyword.status }}</span></p>
    </div>
    <div>
        <p>{{ user.userprofile.preferred_name }}, your current vote to approve or reject the use of the keyword '{{ keyword.word }}' in this project is:
            <span id="keyword_user_vote" class="{{ keyword_user_vote|lower }}">{{ keyword_user_vote }}</span></p>
        <p>You can change your vote anytime using the buttons below.</p>
        <form class="keyword-vote-form" method="post">
            {% csrf_token %}
            <input type="hidden" name="votable_content_type" value="{{ keyword_votable_type }}">
            <input type="hidden" name="votable_object_id" value="{{ keyword_obj }}">
            <input type="hidden" id="keyword_vote" name="vote">
            <button type="button" class="keyword-vote-btn" id="keyword_approve" value="1">Approve</button>
            <button type="button" class="keyword-vote-btn" id="keyword_reject" value="-1">Reject</button>
            <button type="button" class="keyword-vote-btn" id="keyword_no_vote" value="0">No Vote</button>
        </form>
    </div>

    <div class="keyword-stats">
        <h5>Community vote data for keyword {{ keyword.word }}:</h5>
        <table>
            <tr>
                <th>Total Votes</th>
                <th>Approve Votes</th>
                <th>Reject Votes</th>
                <th>% Participation</th>
                <th>% Approval</th>
            </tr>
            <tr>
                <td id="keyword_total_votes">{{ keyword.total_votes }}</td>
                <td id="keyword_total_approve_votes">{{ keyword.total_approve_votes }}</td>
                <td id="keyword_total_reject_votes">{{ keyword.total_reject_votes }}</td>
                <td id="keyword_participation_percentage">{{ keyword.participation_percentage }}%</td>
                <td id="keyword_approval_percentage">{{ keyword.approval_percentage }}%</td>
            </tr>
        </table>
    </div>
    <div style="display: flex; align-items: baseline;">
        <h2 style="margin-right: 20px;">{{ keyword.word }} definition:</h2>
        <p>Current definition status: <span id="keyword_definition_status" class="{{ keyword_definition.status|lower }}">{{ keyword.definition.status }}</span></p>
    </div>
    <div>
        <p>
            {% if keyword.definition %}
                {{ keyword.definition.definition|highlight_keywords }}
            {% else %}
                "No definition available"
            {% endif %}
        </p>
    </div>
    <div>
        <p>{{ user.userprofile.preferred_name }}, your current vote to approve this definition of the keyword '{{ keyword.word }}'is:
            <span id="keyword_definition_user_vote" class="{{ keyword_definition_user_vote|lower }}">{{ keyword_definition_user_vote }}</span></p>
        <p>You can change your vote anytime using the buttons below.</p>
        <form class="definition-vote-form" method="post">
            {% csrf_token %}
            <input type="hidden" name="votable_content_type" value="{{ keyword_definition_votable_type }}">
            <input type="hidden" name="votable_object_id" value="{{ keyword_definition_obj }}">
            <input type="hidden" id="keyword_definition_vote" name="vote">
            <button type="button" class="definition-vote-btn" id="keyword_definition_approve" value="1">Approve</button>
            <button type="button" class="definition-vote-btn" id="keyword_definition_reject" value="-1">Reject</button>
            <button type="button" class="definition-vote-btn" id="keyword_definition_no_vote" value="0">No Vote</button>
        </form>
    </div>
<div class="keyword-definition-stats">
        <h5>Community vote data for the definition of {{ keyword.word }}:</h5>
        <table>
            <tr>
                <th>Total Votes</th>
                <th>Approve Votes</th>
                <th>Reject Votes</th>
                <th>% Participation</th>
                <th>% Approval</th>
            </tr>
            <tr>
                <td id="keyword_definition_total_votes">{{ keyword.definition.total_votes }}</td>
                <td id="keyword_definition_total_approve_votes">{{ keyword.definition.total_approve_votes }}</td>
                <td id="keyword_definition_total_reject_votes">{{ keyword.definition.total_reject_votes }}</td>
                <td id="keyword_definition_participation_percentage">{{ keyword.definition.participation_percentage }}%</td>
                <td id="keyword_definition_approval_percentage">{{ keyword.definition.approval_percentage }}%</td>
            </tr>
        </table>
    </div>
    <h6>Suggest a new keyword:</h6>
    <form method="post">
        {% csrf_token %}
        {{ keyword_form|crispy }}
        <input type="submit" class="propose-btn" name="keyword_submit" value="Propose">
    </form>
    {% if keyword_error %}
        <div class="alert alert-danger" role="alert">
            {{ keyword_error }}
        </div>
    {% endif %}
<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        document.querySelectorAll('a[data-word], span[data-word]').forEach((element) => {
            element.addEventListener('click', (event) => {
                let word = event.target.getAttribute('data-word');
                const status = event.target.className.split(' ')[1]; // This assumes the status is always the second class

                if (status === undefined) {
                    event.preventDefault();
                    const input = document.querySelector('#id_word'); // Replace 'id_word' with your actual input id
                    if (input) {
                        input.value = word.charAt(0).toUpperCase() + word.slice(1);
                    }
                }
            });
        });

        function processVote(buttonsSelector, voteInputId, voteFormSelector, voteOutputIds) {
            document.querySelectorAll(buttonsSelector).forEach((element) => {
                element.addEventListener('click', (event) => {
                    event.preventDefault();

                    let voteValue;
                    if (event.target.id.endsWith('_approve')) {
                        voteValue = 1;
                    } else if (event.target.id.endsWith('_reject')) {
                        voteValue = -1;
                    } else {
                        voteValue = 0;
                    }

                    // Set the vote value to the hidden field
                    let voteInput = document.getElementById(voteInputId);
                    voteInput.value = voteValue;

                    $.ajax({
                        url : "{% url 'app01:submit_vote' %}",
                        type : "POST",
                        data : $(voteFormSelector).serialize(),

                        success : function(json) {
                            // Update the vote statistics and status
                            $(voteOutputIds.total_votes).text(json.total_votes);
                            $(voteOutputIds.total_approve_votes).text(json.total_approve_votes);
                            $(voteOutputIds.total_reject_votes).text(json.total_reject_votes);
                            $(voteOutputIds.participation_percentage).text(json.participation_percentage);
                            $(voteOutputIds.approval_percentage).text(json.approval_percentage);
                            $(voteOutputIds.status).text(json.status);
                            $(voteOutputIds.user_vote).text(json.user_vote);

                            // Update the status class
                            $(voteOutputIds.status).removeClass('approved proposed rejected alternative');
                            if (json.status === 'Approved') {
                                $(voteOutputIds.status).addClass('approved');
                            } else if (json.status === 'Proposed') {
                                $(voteOutputIds.status).addClass('proposed');
                            } else if (json.status === 'Rejected') {
                                $(voteOutputIds.status).addClass('rejected');
                            } else if (json.status === 'Alternative') {
                                $(voteOutputIds.status).addClass('alternative');
                            }

                            // Update the user_vote class
                            $(voteOutputIds.user_vote).removeClass('approve reject no-vote');
                            if (json.user_vote == 'Approve') {
                                $(voteOutputIds.user_vote).addClass('approve');
                            } else if (json.user_vote == 'Reject') {
                                $(voteOutputIds.user_vote).addClass('reject');
                            } else {
                                $(voteOutputIds.user_vote).addClass('no-vote');
                            }
                        },

                        error : function(xhr,errmsg,err) {
                            console.log(xhr.status + ": " + xhr.responseText);
                        }
                    });
                });
            });
        }

        processVote('.keyword-vote-btn', 'keyword_vote', '.keyword-vote-form', {
            total_votes: '#keyword_total_votes',
            total_approve_votes: '#keyword_total_approve_votes',
            total_reject_votes: '#keyword_total_reject_votes',
            participation_percentage: '#keyword_participation_percentage',
            approval_percentage: '#keyword_approval_percentage',
            status: '#keyword_status',
            user_vote: '#keyword_user_vote',
        });

        processVote('.definition-vote-btn', 'keyword_definition_vote', '.definition-vote-form', {
            total_votes: '#keyword_definition_total_votes',
            total_approve_votes: '#keyword_definition_total_approve_votes',
            total_reject_votes: '#keyword_definition_total_reject_votes',
            participation_percentage: '#keyword_definition_participation_percentage',
            approval_percentage: '#keyword_definition_approval_percentage',
            status: '#keyword_definition_status',
            user_vote: '#keyword_definition_user_vote',
        });
    });
</script>
{% endblock %}

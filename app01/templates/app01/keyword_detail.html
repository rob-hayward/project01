{% extends "app01/base.html" %}
{% load crispy_forms_tags %}
{% load highlight_keywords %}
{% load static %}

{% block content %}
    <div style="display: flex; align-items: baseline;">
        <h1 style="margin-right: 20px;">{{ keyword.word }}</h1>
        <p>Current keyword status: <span id="keyword_status" class="{{ keyword.status|lower }}">{{ keyword.status }}</span></p>
    </div>
    <div>
        <p>{{ user.userprofile.preferred_name }}, your current vote to approve or reject the use of the keyword '{{ keyword.word }}' in this project is:
            <span id="keyword_user_vote" class="{{ keyword_user_vote|lower }}">{{ keyword_user_vote }}</span></p>
        <p>You can change your vote anytime using the buttons below.</p>
        <form class="keyword-vote-form" method="post">
            {% csrf_token %}
            <input type="hidden" name="votable_content_type" value="{{ keyword_votable_type }}">
            <input type="hidden" name="votable_object_id" value="{{ keyword_obj }}">
            <input type="hidden" id="keyword_vote" name="vote">
            <button type="button" class="keyword-vote-btn" id="keyword_approve" value="1">Approve</button>
            <button type="button" class="keyword-vote-btn" id="keyword_reject" value="-1">Reject</button>
            <button type="button" class="keyword-vote-btn" id="keyword_no_vote" value="0">No Vote</button>
        </form>
    </div>

    <div class="keyword-stats">
        <h5>Community vote data for keyword {{ keyword.word }}:</h5>
        <div id="keyword-pie-chart" style="width: 100%; height: 500px;"></div>
        <table>
            <tr>
                <th>Total Votes</th>
                <th>Approve Votes</th>
                <th>Reject Votes</th>
                <th>% Participation</th>
                <th>% Approval</th>
            </tr>
            <tr>
                <td id="keyword_total_votes">{{ keyword.total_votes }}</td>
                <td id="keyword_total_approve_votes">{{ keyword.total_approve_votes }}</td>
                <td id="keyword_total_reject_votes">{{ keyword.total_reject_votes }}</td>
                <td id="keyword_participation_percentage">{{ keyword.participation_percentage }}%</td>
                <td id="keyword_approval_percentage">{{ keyword.approval_percentage }}%</td>
            </tr>
        </table>
    </div>
    <div style="display: flex; align-items: baseline;">
        <h2 style="margin-right: 20px;">{{ keyword.word }} definition:</h2>
        <p>Current definition status: <span id="keyword_definition_status" class="{{ keyword_definition.status|lower }}">{{ keyword.definition.status }}</span></p>
    </div>
    <div>
        <p>
            {% if keyword.definition %}
                {{ keyword.definition.definition|highlight_keywords }}
            {% else %}
                "No definition available"
            {% endif %}
        </p>
    </div>
    <div>
        <p>{{ user.userprofile.preferred_name }}, your current vote to approve this definition of the keyword '{{ keyword.word }}'is:
            <span id="keyword_definition_user_vote" class="{{ keyword_definition_user_vote|lower }}">{{ keyword_definition_user_vote }}</span></p>
        <p>You can change your vote anytime using the buttons below.</p>
        <form class="definition-vote-form" method="post">
            {% csrf_token %}
            <input type="hidden" name="votable_content_type" value="{{ keyword_definition_votable_type }}">
            <input type="hidden" name="votable_object_id" value="{{ keyword_definition_obj }}">
            <input type="hidden" id="keyword_definition_vote" name="vote">
            <button type="button" class="definition-vote-btn" id="keyword_definition_approve" value="1">Approve</button>
            <button type="button" class="definition-vote-btn" id="keyword_definition_reject" value="-1">Reject</button>
            <button type="button" class="definition-vote-btn" id="keyword_definition_no_vote" value="0">No Vote</button>
        </form>
    </div>
<div class="keyword-definition-stats">
    <h5>Community vote data for the definition of {{ keyword.word }}:</h5>
    <div id="definition-pie-chart" style="width: 100%; height: 500px;"></div>
        <table>
            <tr>
                <th>Total Votes</th>
                <th>Approve Votes</th>
                <th>Reject Votes</th>
                <th>% Participation</th>
                <th>% Approval</th>
            </tr>
            <tr>
                <td id="keyword_definition_total_votes">{{ keyword.definition.total_votes }}</td>
                <td id="keyword_definition_total_approve_votes">{{ keyword.definition.total_approve_votes }}</td>
                <td id="keyword_definition_total_reject_votes">{{ keyword.definition.total_reject_votes }}</td>
                <td id="keyword_definition_participation_percentage">{{ keyword.definition.participation_percentage }}%</td>
                <td id="keyword_definition_approval_percentage">{{ keyword.definition.approval_percentage }}%</td>
            </tr>
        </table>
    </div>
    <h2>Propose a new Keyword and Definition:</h2>
    <form method="post">
        {% csrf_token %}
        {{ keyword_form|crispy }}
        <input type="submit" class="propose-btn" name="keyword_submit" value="Propose">
    </form>
    {% if keyword_error %}
        <div class="alert alert-danger" role="alert">
            {{ keyword_error }}
        </div>
    {% endif %}
<script src="https://d3js.org/d3.v6.min.js"></script>
{% endblock %}

{% block extra_js %}
    <script>
        const voteUrl = "{% url 'app01:submit_vote' %}";
    </script>
    <script type="module" src="{% static 'app01/js/keyword_detail.js' %}"></script>
    <script type="module" src="{% static 'app01/js/binary_pie_chart.js' %}"></script>
{% endblock %}

{% extends "app01/base.html" %}
{% load crispy_forms_tags %}
{% load highlight_keywords %}

{% block content %}
    <div style="display: flex; align-items: baseline;">
        <h1 style="margin-right: 20px;">{{ keyword.word }}</h1>

        <!-- Add a vote form -->
        <form class="vote-form" method="post">
            {% csrf_token %}
            <input type="hidden" name="votable_content_type" value="{{ votable_content_type }}">
            <input type="hidden" name="votable_object_id" value="{{ votable_object_id }}">
            <select id="vote" name="vote">
                <option value="">Vote</option>
                <option value="1">Approve</option>
                <option value="-1">Reject</option>
                <option value="0">No Vote</option>
            </select>
        </form>




    </div>

    <div class="keyword-stats">
        <table>
            <tr>
                <th>Status</th>
                <th>Total Votes</th>
                <th>Approve Votes</th>
                <th>Reject Votes</th>
                <th>% Participation</th>
                <th>% Approval</th>
            </tr>
            <tr>
                <td id="status">{{ keyword.status }}</td>
                <td id="total_votes">{{ keyword.total_votes }}</td>
                <td id="total_approve_votes">{{ keyword.total_approve_votes }}</td>
                <td id="total_reject_votes">{{ keyword.total_reject_votes }}</td>
                <td id="participation_percentage">{{ keyword.participation_percentage }}%</td>
                <td id="approval_percentage">{{ keyword.approval_percentage }}%</td>
            </tr>
        </table>
    </div>

    <p>
        {{ keyword.word }} definition:
        {% if keyword.definition %}
            {{ keyword.definition.definition|highlight_keywords }}
        {% else %}
            "No definition available"
        {% endif %}
    </p>

    <h6>Suggest a new keyword:</h6>
    <form method="post">
        {% csrf_token %}
        {{ keyword_form|crispy }}
        <input type="submit" name="keyword_submit" value="Suggest Keyword">
    </form>

    {% if keyword_error %}
        <div class="alert alert-danger" role="alert">
            {{ keyword_error }}
        </div>
    {% endif %}
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
   <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('a[data-word], span[data-word]').forEach((element) => {
                element.addEventListener('click', (event) => {
                    let word = event.target.getAttribute('data-word');
                    const status = event.target.className.split(' ')[1]; // This assumes the status is always the second class

                    if (status === undefined) {
                        event.preventDefault();
                        const input = document.querySelector('#id_word'); // Replace 'id_word' with your actual input id
                        if (input) {
                            input.value = word.charAt(0).toUpperCase() + word.slice(1);
                        }
                    }
                });
            });

            $('#vote').on('change', function(){
                $.ajax({
                    url : "{% url 'app01:submit_vote' %}",
                    type : "POST",
                    data : $('.vote-form').serialize(),

                    success : function(json) {
                        // update the keyword stats on successful vote
                        $('#total_votes').text(json.total_votes);
                        $('#total_approve_votes').text(json.total_approve_votes);
                        $('#total_reject_votes').text(json.total_reject_votes);
                        $('#participation_percentage').text(json.participation_percentage);
                        $('#approval_percentage').text(json.approval_percentage);
                    },

                    error : function(xhr,errmsg,err) {
                        console.log(xhr.status + ": " + xhr.responseText);
                    }
                });
            });
        });
    </script>

{% endblock %}
